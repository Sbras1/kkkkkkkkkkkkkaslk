// ==================================================
// ğŸ”¥ Firebase Logs Helper â€” Realtime Database
// ==================================================

const admin = require("firebase-admin");
const path = require("path");
const fs = require("fs");

let appInitialized = false;

function initFirebase() {
  if (appInitialized) return;

  const serviceAccountPath =
    process.env.FIREBASE_SERVICE_ACCOUNT_PATH ||
    path.join(__dirname, "bot-pubg-fd550-firebase-adminsdk-fbsvc-a623e1fe45.json");

  if (!fs.existsSync(serviceAccountPath)) {
    console.error("âŒ Ù…Ù„Ù Ø®Ø¯Ù…Ø© Firebase ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:", serviceAccountPath);
    process.exit(1);
  }

  const dbUrl = process.env.FIREBASE_DB_URL;
  if (!dbUrl) {
    console.error("âŒ FIREBASE_DB_URL ØºÙŠØ± Ù…Ø­Ø¯Ø¯ ÙÙŠ Ù…Ù„Ù .env");
    process.exit(1);
  }

  const serviceAccount = require(serviceAccountPath);

  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
    databaseURL: dbUrl,
  });

  appInitialized = true;
  console.log("âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Firebase Realtime Database Ø¨Ù†Ø¬Ø§Ø­.");
}

function getDb() {
  initFirebase();
  return admin.database();
}

/**
 * Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø¬Ø±
 * @param {number|string} traderId
 * @param {object} data
 */
async function logOperation(traderId, data) {
  const db = getDb();
  const ref = db.ref("logs").child(String(traderId));

  const payload = {
    ...data,
    time: Date.now(),
  };

  await ref.push(payload);
}

/**
 * Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø³Ø¬Ù„Ø§Øª Ù„ØªØ§Ø¬Ø± Ù…Ø¹ÙŠÙ‘Ù†
 * @param {number|string} traderId
 * @param {{page?:number,pageSize?:number}} options
 * @returns {Promise<{items:any[], total:number}>}
 */
async function getTraderLogs(traderId, { page = 1, pageSize = 10 } = {}) {
  const db = getDb();
  const ref = db.ref("logs").child(String(traderId));

  const snap = await ref
    .orderByChild("time")
    .limitToLast(page * pageSize)
    .once("value");

  const val = snap.val() || {};

  const all = Object.values(val).sort(
    (a, b) => (a.time || 0) - (b.time || 0)
  );

  const start = Math.max(0, all.length - pageSize);
  const items = all.slice(start);

  return { items, total: all.length };
}

module.exports = {
  logOperation,
  getTraderLogs,
};